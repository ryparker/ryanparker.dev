# Mark deployed commits as "deployed" in GitHub for Developers and QA who visit the repo website.

name: GitHub Deploy

on:
  create

jobs:
  mark-tagged-ref-as-deployed:
    name: Mark Tagged Ref as Deployed
    runs-on: ubuntu-20.04

    if: github.event.ref_type == 'tag' && endsWith(github.event.ref, '-latest')

    steps:
      - name: Create GitHub Deployment
        uses: actions/github-script@e2ddba4dfcf622c123222f25bce0589fa3d1d493
        with:
          script: |
            const deployment = await github.repos.createDeployment({
              owner: context.payload.repository.owner.login,
              repo: context.payload.repository.name,
              ref: context.payload.ref,
              required_contexts: [],
              auto_merge: false,
              environment: `${context.payload.ref.split('-')[0]}`
            });

            await github.repos.createDeploymentStatus({
              owner: context.payload.repository.owner.login,
              repo: context.payload.repository.name,
              deployment_id: deployment.data.id,
              state: 'success',
              description: `The application has been deployed to ${context.payload.ref.split('-')[0]}.ryanparker.dev via AWS CodeBuild.`
            });
          github-token: ${{secrets.GITHUB_TOKEN}}
